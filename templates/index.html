<!DOCTYPE html>
<html lang="en">

<head>
    <title>Office 21 Secure Message Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/static/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/static/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/static/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/static/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/static/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
    <link rel="manifest" href="/static/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#111">
    <meta name="msapplication-TileImage" content="/static/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#111">
    <link rel="stylesheet" href="/static/tachyons.min.css">
    <link href="https://fonts.googleapis.com/css?family=Acme" rel="stylesheet">
    <style>
        .swal-overlay {
        background-color: rgba(43, 165, 137, 0.45);
        }
        body {
            font-family: 'Acme', sans-serif;
        }

        a,
        a:active,
        a:focus,
        a:hover,
        a:link,
        a:visited {
            transition: color .15s ease-in;
            transition-property: color;
            transition-duration: 0.15s;
            transition-timing-function: ease-in;
            transition-delay: initial;
        }

        a:hover {
            color: #ff4136;
        }

        a:focus {
            color: #ff4136;
        }

        a {
            color: #000;
            text-decoration: none;
            font-weight: 600;
            background-color: transparent;
            cursor: pointer;
        }

        html {
            height: 100%;
        }

        body {
            min-height: 100%;
            display: grid;
            grid-template-rows: 1fr auto;
        }

        .footer {
            grid-row-start: 2;
            grid-row-end: 3;
        }

        [contenteditable]:focus {
            outline: 0px solid transparent;
        }
        div:empty:before {
            content:attr(data-text);
            color:gray
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="pa3 pa4-ns mt5">
            <div class="black b f1 f-headline-ns tc db mb3 mb4-ns" id="messageHTML" {{ if .Form }}contenteditable="true" data-text="Type your message."{{ end }}>{{ if .Form }}{{else}}{{.Message}}{{end}}</div>
            <div class="tc pb3">
                {{ if .Form }}To: &nbsp;
                <div class="b f6 f5-ns dib mr3" id="recipient" contenteditable="true"  data-text="recipient">{{ with .To }}{{.}}{{end}}</div>
                From: &nbsp;
                <div class="b f6 f5-ns dib mr3" id="sender" contenteditable="true" data-text="Sender">{{ with .From }}{{.}}{{end}}</div>
                <a class="link dim gray f6 f5-ns dib mr3" id="sendmessage">Send</a>
                {{ else }}
                <div class="b gray f6 f5-ns dib mr3" id="submessageHTML" >{{.Submessage}}</div>
                <a class="link dim gray f6 f5-ns dib mr3" id="nextmessage">{{ if .MoreMessages}}Next{{end}}</a>
                {{ end }}
                <div class="b gray f6 f5-ns dib mr3" id="connectionInfo" ></div>
            </div>
        </div>
        <div class="push"></div>
    </div>
    <div class="footer">
        <footer class="bg-near-black white-80 pv4 pv5-l ph4 mt4">
            <p class="f4 tc">
                {{ if .Form }}
                <span class="dib mr4 mr5-ns">
                <span class="gray">writing</span>&nbsp;
                <a class="link white-80 hover-light-purple" href="/">snaptext</a>
                <span class="gray"><br>&nbsp;</span>
                </span>
                {{ else }}
                <span class="dib mr4 mr5-ns">
                        <span class="gray">reading</span>&nbsp;
                        <a class="link white-80 hover-light-purple" href="/">snaptext</a>
                        <span class="gray">
                        <br>messages for <a class="link white-80 hover-light-green" href="/?from={{ .Name }}">{{ .Name }}</a></span>
                    </span>
                {{ end }}
                <span class="dib  mr4 gray dim mr5-ns">Messages are read once, then deleted forever.<br>&nbsp;</span>        
        </p>
            
            <p class="tc mt4">
                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="94px" height="88px" viewBox="0 0 94 88" enable-background="new 0 0 94 88" xml:space="preserve">
<path fill-rule="evenodd" clip-rule="evenodd" fill="#999999" d="M86.502,34.214v31.6c-0.011,0.883-0.33,1.636-0.957,2.264
	c-0.65,0.648-1.434,0.975-2.35,0.975c-0.756,0-1.417-0.221-1.984-0.66L72,59.216c-3.424,1.868-7.197,2.92-11.317,3.151H59.29
	c2.136-3.922,3.204-8.293,3.204-13.11c0-1.381-0.088-2.721-0.262-4.022c-0.963,0.291-1.984,0.438-3.064,0.438
	c-2.867,0-5.305-1.011-7.313-3.031c-2.008-1.995-3.013-4.428-3.013-7.294c0-2.844,1.005-5.276,3.013-7.296
	c0.116-0.116,0.232-0.22,0.348-0.313c-0.023-0.011-0.041-0.028-0.052-0.052c-4.909-4.005-10.649-6.007-17.22-6.007l-0.208-0.122
	c1.219-2.205,2.792-4.277,4.718-6.215c5.386-5.375,11.886-8.062,19.5-8.062c7.625,0,14.126,2.687,19.5,8.062
	C83.677,20.576,86.363,26.867,86.502,34.214z M52.203,27.737c0.766,0.627,1.51,1.301,2.229,2.02c4.4,4.4,7,9.559,7.801,15.478
	c1.566-0.475,2.977-1.34,4.23-2.594c1.996-1.995,2.995-4.428,2.995-7.294c0-2.844-0.999-5.276-2.995-7.296
	c-2.02-2.007-4.451-3.012-7.295-3.012C56.463,25.039,54.143,25.938,52.203,27.737z M42.018,42.45c2.02,2.021,3.03,4.458,3.03,7.313
	c0,2.751-0.928,5.101-2.786,7.051c4.342,3.377,9.32,5.229,14.939,5.554c0.568,0.023,1.148,0.034,1.74,0.034l0.244,0.157v0.019
	c-1.254,2.193-2.838,4.248-4.754,6.163c-4.967,4.968-10.881,7.644-17.741,8.025h-3.482c-4.132-0.221-7.91-1.27-11.334-3.151
	l-9.193,9.177c-0.58,0.452-1.248,0.678-2.002,0.678c-0.905,0-1.688-0.33-2.35-0.992c-0.627-0.626-0.946-1.374-0.958-2.246V48.629
	c0.139-7.347,2.827-13.637,8.062-18.872c5.316-5.316,11.723-8.008,19.222-8.079c-2.183,3.947-3.274,8.333-3.274,13.162
	c0,1.73,0.134,3.402,0.401,5.016c0.929-0.268,1.909-0.401,2.942-0.401C37.59,39.455,40.021,40.453,42.018,42.45z M27.41,57.057
	c2.02,2.021,4.458,3.031,7.313,3.031c2.867,0,5.298-1.011,7.295-3.031c0.082-0.081,0.163-0.161,0.244-0.243
	c-0.975-0.755-1.915-1.579-2.82-2.474c-4.155-4.166-6.708-8.994-7.661-14.484c-1.625,0.453-3.082,1.317-4.371,2.594
	c-1.996,2.021-2.994,4.458-2.994,7.313S25.414,55.048,27.41,57.057z"/>
</svg>

            </p>
            <p class="f6 tc gray">
                snaptext <a class="silver hover-light-purple" href="https://github.com/schollz/snaptext">source</a> is free as in freedom
            </p>
        </footer>
    </div>


    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script type="text/javascript">
        window.swal = swal;
        var conn;
        window.onload = function () {
            {{ if .Form }}
            function postData() {
                console.log("submitting message");
                var xhr = new XMLHttpRequest();
                var url = "url";
                xhr.open("POST", "/", true);
                xhr.setRequestHeader("Content-type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var jsonPayload = JSON.parse(xhr.responseText);
                        console.log(jsonPayload);
                        if (jsonPayload.success==true) {
                            swal({
                                text: jsonPayload.message,
                                icon: "success",
                            });
                            document.getElementById("messageHTML").innerText = ""
                            document.getElementById("recipient").innerText = ""
                        } else {
                            swal({
                                text: jsonPayload.message,
                                icon: "error",
                            }); 
                        }
                    }
                };
                var toText = document.getElementById("recipient").innerText;
                var fromText = document.getElementById("sender").innerText;
                var messageText = document.getElementById("messageHTML").innerText;
                var data = JSON.stringify({"to": toText, "from":fromText,"message":messageText});
                console.log(data);
                xhr.send(data);
                return false;
            }
            document.querySelector("#sendmessage").addEventListener("click", function (event) {
                event.preventDefault();
                postData();
                return false;
            }, false);
            document.querySelector('#recipient').addEventListener('keypress', function (e) {
                var key = e.which || e.keyCode;
                if (key === 13) { // 13 is enter
                    e.preventDefault();
                    postData();
                }
            });
            document.querySelector('#sender').addEventListener('keypress', function (e) {
                var key = e.which || e.keyCode;
                if (key === 13) { // 13 is enter
                    e.preventDefault();
                    postData();
                }
            });
            {{ else }}
            document.querySelector("#nextmessage").addEventListener("click", function (event) {
                event.preventDefault();
                console.log("next message")
                if (!conn) {
                    return false;
                }
                conn.send(JSON.stringify({
                    "name": "{{ .Name }}",
                    "message": "next"
                }));
                return false;
            }, false);
            {{ end }}
            var reconnection;

            function connect() {
                console.log("trying to connect")
                if (window["WebSocket"]) {
                    console.log("connecting to server")
                    conn = new WebSocket(window.location.origin.replace("http", "ws") + "/ws?name={{ .Name }}");
                    conn.onclose = function (evt) {
                        console.log("connection closed")
                        document.getElementById("connectionInfo").innerHTML = "<em>No connection.</em>";
                        reconnection = setTimeout(function () {
                            connect();
                        }, 1000);
                    };
                    conn.onmessage = function (evt) {
                        data = JSON.parse(evt.data)
                        console.log(data);
                        if (typeof data.message != 'undefined') {
                            document.getElementById("messageHTML").innerHTML = data.message
                            document.getElementById("submessageHTML").innerHTML = data.submessage
                        }
                        if (data.meta != "") {
                            document.getElementById("nextmessage").innerHTML = "Next"
                        } else {
                            document.getElementById("nextmessage").innerHTML = ""
                        }
                    };
                    conn.onerror = function (evt) {
                        console.log("error")
                        console.log(evt);
                    }
                    conn.onopen = function (evt) {
                        clearTimeout(reconnection);
                        console.log("connected")
                        document.getElementById("connectionInfo").innerHTML = "";
                        // conn.send(JSON.stringify({
                        //     "name": "{{ .Name }}",
                        //     "message": "next"
                        // }));
                    }
                } else {
                    var item = document.getElementById("messageHTML");
                    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                }
            } 
            {{if not .Form }}
            connect(); 
           {{ end }}

            document.getElementById("messageHTML").focus();
        };
    </script>
</body>

</html>